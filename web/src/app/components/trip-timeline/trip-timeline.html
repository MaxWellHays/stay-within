<div class="timeline-container">
    @if (chartWidth() > 0) {
    <!-- ── SVG Chart ───────────────────────────────────────────────────────── -->
    <svg
        class="timeline-svg"
        [attr.width]="chartWidth()"
        [attr.height]="svgHeight()"
        (mouseleave)="onMouseLeave()"
        (touchmove)="onTouchMove($event)"
        (touchend)="onMouseLeave()"
    >
        <g [attr.transform]="'translate(' + MARGIN.left + ',' + marginTop() + ')'">
            <!-- Window highlight background -->
            <rect
                class="window-bg"
                [attr.x]="windowRect().x"
                [attr.y]="0"
                [attr.width]="windowRect().width"
                [attr.height]="barAreaHeight()"
            />

            <!-- Trip bars -->
            @for (bar of tripBarsWithNotes(); track bar.trip.start.getTime()) {
            <rect
                class="trip-bar"
                [attr.x]="bar.x"
                [attr.y]="bar.lane * LANE_STEP"
                [attr.width]="bar.width"
                [attr.height]="BAR_HEIGHT"
                [attr.fill]="hoveredTrip() === bar.trip ? bar.tripColor.barHover : (bar.inWindow ? bar.tripColor.bar : bar.tripColor.barFaded)"
                [attr.opacity]="hoveredTrip() === bar.trip ? 1 : (bar.inWindow ? 1 : 0.7)"
                [attr.stroke]="hoveredTrip() === bar.trip ? '#374151' : 'none'"
                [attr.stroke-width]="hoveredTrip() === bar.trip ? 1.5 : 0"
                rx="3"
            >
                <title>
                    {{ formatDate(bar.trip.start) }} – {{ formatDate(bar.trip.end) }}{{
                    bar.trip.notes ? ' · ' + bar.trip.notes : '' }} ({{ bar.trip.days }} days)
                </title>
            </rect>
            @if (bar.labelVisible) {
            <text
                class="bar-label"
                [attr.x]="bar.x + bar.width / 2"
                [attr.y]="bar.lane * LANE_STEP + BAR_HEIGHT / 2 + 4"
            >
                {{ bar.trip.days }}d
            </text>
            } @if (bar.noteRow >= 0) {
            <!-- Connector line from bar top to badge anchor -->
            <line
                class="note-connector"
                [attr.x1]="bar.x"
                [attr.y1]="bar.lane * LANE_STEP"
                [attr.x2]="bar.noteX"
                [attr.y2]="-(NOTE_ANCHOR_Y)"
                [attr.stroke]="hoveredTrip() === bar.trip ? bar.tripColor.badgeStrokeHover : (bar.inWindow ? bar.tripColor.badgeStroke : bar.tripColor.badgeStrokeFaded)"
            />
            <!-- Rotated note badge (bottom-left corner at bar top) -->
            <g
                [attr.transform]="'translate(' + bar.noteX + ',' + (-(NOTE_ANCHOR_Y)) + ') rotate(' + NOTE_ANGLE + ')'"
            >
                <rect
                    class="note-badge-bg"
                    x="0"
                    y="0"
                    [attr.width]="bar.noteWidth"
                    [attr.height]="NOTE_BADGE_HEIGHT"
                    rx="3"
                    [attr.fill]="hoveredTrip() === bar.trip ? bar.tripColor.badgeBgHover : (bar.inWindow ? bar.tripColor.badgeBg : bar.tripColor.badgeBgFaded)"
                    [attr.stroke]="hoveredTrip() === bar.trip ? bar.tripColor.badgeStrokeHover : (bar.inWindow ? bar.tripColor.badgeStroke : bar.tripColor.badgeStrokeFaded)"
                />
                <text
                    class="bar-note"
                    [attr.x]="bar.noteWidth / 2"
                    y="11"
                    [attr.fill]="hoveredTrip() === bar.trip ? bar.tripColor.badgeTextHover : (bar.inWindow ? bar.tripColor.badgeText : bar.tripColor.badgeTextFaded)"
                >
                    {{ bar.trip.notes }}
                </text>
            </g>
            } }

            <!-- Window start vertical marker -->
            @if (windowStartX() >= 0 && windowStartX() <= innerWidth()) {
            <line
                class="window-marker window-start-marker"
                [attr.x1]="windowStartX()"
                [attr.x2]="windowStartX()"
                [attr.y1]="0"
                [attr.y2]="barAreaHeight()"
            />
            }

            <!-- Window end / today marker -->
            @if (windowEndX() >= 0 && windowEndX() <= innerWidth()) {
            <line
                class="window-marker window-end-marker"
                [attr.x1]="windowEndX()"
                [attr.x2]="windowEndX()"
                [attr.y1]="0"
                [attr.y2]="barAreaHeight()"
            />
            }

            <!-- Today line (only when not hovering) -->
            @if (!hoverDate() && todayX() >= 0 && todayX() <= innerWidth()) {
            <line
                class="today-marker"
                [attr.x1]="todayX()"
                [attr.x2]="todayX()"
                [attr.y1]="0"
                [attr.y2]="barAreaHeight()"
            />
            }

            <!-- Floating window date badges (always visible, clamped to edges) -->
            <g
                class="window-badge"
                [attr.transform]="'translate(' + startBadgeX() + ',' + (barAreaHeight() + 6) + ')'"
            >
                @if (startBadgeArrowVisible()) {
                <polygon
                    class="window-badge-arrow"
                    [attr.transform]="'translate(' + (windowStartX() - startBadgeX()) + ',0)'"
                    points="-4,0 0,-5 4,0"
                />
                }
                <rect class="window-badge-bg" x="-36" y="0" width="72" height="18" rx="3" />
                <text class="window-badge-text" x="0" y="13">
                    {{ formatDate(activeWindowStart()) }}
                </text>
            </g>
            <g
                class="window-badge"
                [attr.transform]="'translate(' + endBadgeX() + ',' + (barAreaHeight() + 6) + ')'"
            >
                @if (endBadgeArrowVisible()) {
                <polygon
                    class="window-badge-arrow"
                    [attr.transform]="'translate(' + (windowEndX() - endBadgeX()) + ',0)'"
                    points="-4,0 0,-5 4,0"
                />
                }
                <rect class="window-badge-bg" x="-36" y="0" width="72" height="18" rx="3" />
                <text class="window-badge-text" x="0" y="13">
                    {{ formatDate(activeWindowEnd()) }}
                </text>
            </g>

            <!-- Floating stats badge -->
            <g
                class="window-badge"
                [attr.transform]="'translate(' + statsBadgeX() + ',' + (barAreaHeight() + 4 + statsBadgeRowOffset()) + ')'"
            >
                <rect
                    class="stats-badge-bg"
                    x="-44"
                    y="0"
                    width="88"
                    height="30"
                    rx="4"
                    [attr.fill]="statsBadgeBg()"
                    [attr.stroke]="statsBadgeStroke()"
                />
                <text class="stats-badge-num" x="0" y="12" [attr.fill]="statsBadgeTextColor()">
                    {{ infoDaysOutside() }} / {{ infoLimit() }}
                </text>
                <text class="stats-badge-label" x="0" y="24" [attr.fill]="statsBadgeTextColor()">
                    {{ statusLabel() }}
                </text>
            </g>

            <!-- X axis ticks and labels -->
            @for (tick of axisTicks(); track tick.label) {
            <line
                class="axis-tick"
                [attr.x1]="tick.x"
                [attr.x2]="tick.x"
                [attr.y1]="barAreaHeight() + WINDOW_LABEL_ROW + statsBadgeRowOffset()"
                [attr.y2]="barAreaHeight() + WINDOW_LABEL_ROW + statsBadgeRowOffset() + 5"
            />
            <text
                class="axis-label"
                [attr.x]="tick.x"
                [attr.y]="barAreaHeight() + WINDOW_LABEL_ROW + statsBadgeRowOffset() + 18"
            >
                {{ tick.label }}
            </text>
            }

            <!-- Invisible overlay to capture hover events across the full chart area -->
            <rect
                class="hover-overlay"
                x="0"
                [attr.y]="-(marginTop())"
                [attr.width]="innerWidth()"
                [attr.height]="svgHeight()"
                (mousemove)="onMouseMove($event)"
                (click)="onDebugClick($event)"
            />
        </g>
    </svg>

    }
</div>
